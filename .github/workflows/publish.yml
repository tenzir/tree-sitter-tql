name: Publish packages

on:
  push:
    tags: ["*"]

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  github:
    name: Release to GitHub
    uses: tree-sitter/workflows/.github/workflows/release.yml@main
    with:
      generate: true
  prebuilds:
    name: Build prebuilds (${{matrix.os}})
    needs: github
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{vars.NODE_VERSION || '22'}}
      - name: Install dependencies
        run: npm ci
      - name: Build prebuilds
        run: npx prebuildify --napi --strip
      - name: Build prebuilds (cross-compile arm64)
        if: matrix.os == 'macos-latest'
        run: npx prebuildify --napi --strip --arch arm64
      - name: Upload prebuild artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{runner.os}}
          path: prebuilds/
  upload-prebuilds:
    name: Upload prebuilds to release
    needs: prebuilds
    runs-on: ubuntu-latest
    steps:
      - name: Download all prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: prebuilds-*
          path: prebuilds-all
          merge-multiple: true
      - name: Create prebuilds archive
        run: |
          tar -czf prebuilds.tar.gz -C prebuilds-all .
          ls -la prebuilds-all/
      - name: Upload prebuilds to release
        env:
          GITHUB_TOKEN: ${{github.token}}
        run: gh release upload "${GITHUB_REF_NAME}" prebuilds.tar.gz --clobber --repo ${{github.repository}}
  bundle:
    name: Package editor artifacts
    needs: github
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{vars.NODE_VERSION || '22'}}
      - name: Set up tree-sitter CLI
        uses: tree-sitter/setup-action/cli@v2
        with:
          tree-sitter-ref: v0.25.4
      - name: Build Wasm parser
        run: tree-sitter build --wasm
      - name: Assemble bundle
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          DEST="bundle/tree-sitter-tql-${VERSION}"
          rm -rf bundle
          mkdir -p "$DEST/src"
          cp grammar.js tree-sitter.json "$DEST/"
          cp tree-sitter-tql.wasm "$DEST/"
          cp src/parser.c src/node-types.json src/grammar.json "$DEST/src/"
          if [ -d queries ]; then
            cp -R queries "$DEST/"
          fi
          tar -czf "tree-sitter-tql-${VERSION}-bundle.tar.gz" -C bundle "tree-sitter-tql-${VERSION}"
          printf '%s\n' "tree-sitter-tql-${VERSION}-bundle.tar.gz" >> "$GITHUB_STEP_SUMMARY"
      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{github.token}}
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          gh release upload "${GITHUB_REF_NAME}" "tree-sitter-tql-${VERSION}-bundle.tar.gz" --clobber
          gh release upload "${GITHUB_REF_NAME}" tree-sitter-tql.wasm --clobber
  npm:
    name: Publish npm package
    needs: [prebuilds, bundle]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{vars.NODE_VERSION || '22'}}
          registry-url: https://registry.npmjs.org
      - name: Download all prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: prebuilds-*
          path: prebuilds
          merge-multiple: true
      - name: Download WASM artifact
        env:
          GITHUB_TOKEN: ${{github.token}}
        run: gh release download "${GITHUB_REF_NAME}" --pattern "tree-sitter-tql.wasm" --repo ${{github.repository}}
      - name: Verify artifacts
        run: |
          echo "Prebuilds:"
          ls -la prebuilds/
          echo "WASM:"
          ls -la tree-sitter-tql.wasm
      - name: Upgrade npm for OIDC support
        run: npm install -g npm@latest && npm --version
      - name: Publish to npm with provenance
        run: npm publish --access public --provenance
  pypi:
    name: Publish PyPI package
    uses: tree-sitter/workflows/.github/workflows/package-pypi.yml@main
    needs: github
    secrets:
      PYPI_API_TOKEN: ${{secrets.PYPI_API_TOKEN}}
    with:
      generate: true
